# Windows环境变量管理工具 - 项目需求文档

## 1. 项目概述

### 1.1 项目名称
Windows环境变量管理工具 (EnvManager)

### 1.2 项目目标
开发一个基于PySide6的Windows环境变量管理工具，提供友好的图形界面来管理系统和用户环境变量。项目采用分阶段开发策略：
- **第一阶段**：开发功能完整的独立桌面应用程序
- **第二阶段**：在现有基础上扩展插件化架构，支持集成到其他PySide6项目中

### 1.3 项目背景
- Windows系统自带的环境变量编辑界面操作繁琐，用户体验较差
- 开发人员和系统管理员需要一个更高效的环境变量管理工具
- 需要支持批量操作、备份恢复等高级功能
- 采用渐进式开发，先完成核心功能，后续扩展插件化能力

### 1.4 目标用户
- 软件开发人员
- 系统管理员
- 高级计算机用户
- 需要频繁操作环境变量的用户

## 2. 功能需求

### 2.1 核心功能需求

#### 2.1.1 环境变量管理
- **查看功能**
  - 分别显示系统环境变量和用户环境变量
  - 支持变量名和变量值的完整显示
  - 提供变量详细信息查看（类型、来源等）

- **编辑功能**
  - 添加新的环境变量
  - 修改现有环境变量的值
  - 删除环境变量
  - 支持PATH变量的路径列表编辑

- **搜索过滤**
  - 按变量名搜索
  - 按变量值搜索
  - 支持正则表达式搜索
  - 实时过滤显示

#### 2.1.2 批量操作
- 批量导入环境变量（默认YAML格式，同时支持JSON、CSV、REG格式）
- 批量导出环境变量（默认YAML格式，可选择其他格式）
- 批量删除选中的环境变量
- 从文件或剪贴板批量添加

#### 2.1.3 备份与恢复
- 自动备份功能（操作前自动创建快照）
- 手动创建备份
- 从备份恢复环境变量
- 备份历史管理和清理

#### 2.1.4 PATH变量专用功能
由于PATH环境变量的特殊性（包含多个用分号分隔的路径），需要提供专门的编辑功能：

- **PATH专用编辑器**
  - 将PATH值拆分为独立的路径列表显示
  - 支持路径的添加、删除、移动（上移/下移）
  - 提供"浏览文件夹"按钮快速添加路径
  - 显示路径序号和总数量

- **PATH路径验证**
  - 实时检查路径是否存在
  - 标识无效路径（红色显示）
  - 检测重复路径并提供去重选项
  - 检查路径长度是否超过Windows限制

- **PATH管理功能**
  - 批量删除无效路径
  - 自动去重功能
  - 路径排序（按字母序或使用频率）
  - 导出/导入PATH配置
  - PATH备份和快速切换

- **PATH显示优化**
  - 主列表中PATH值显示为"[X个路径]"格式，避免过长
  - 鼠标悬停显示完整PATH内容
  - 支持快速预览前几个重要路径

#### 2.1.5 高级功能
- 操作撤销/重做
- 变量值验证（路径有效性检查等）
- 重复变量检测和清理
- 环境变量使用统计和分析

### 2.2 桌面应用功能需求

#### 2.2.1 完整的用户界面
- 功能完整的主窗口界面
- 菜单栏和工具栏
- 状态栏显示操作信息
- 系统托盘集成

#### 2.2.2 便捷操作支持
- 支持键盘快捷键
- 右键上下文菜单
- 拖拽操作支持
- 多选批量操作

### 2.3 系统集成需求
- Windows注册表安全操作
- UAC权限提升处理
- 系统环境变量变更通知
- 多用户环境支持

### 2.4 扩展性设计（第二阶段）
- 预留插件接口设计空间
- 模块化架构便于后续重构
- 核心业务逻辑与UI解耦
- 标准化的数据访问接口

## 3. 非功能需求

### 3.1 性能要求
- 启动时间不超过3秒
- 界面响应时间不超过500ms
- 支持处理1000+环境变量项目
- 内存占用不超过100MB

### 3.2 可用性要求
- 界面简洁直观，符合Windows设计规范
- 支持键盘快捷键操作
- 提供操作帮助和提示信息
- 支持多语言（中文、英文）

### 3.3 可靠性要求
- 应用程序崩溃恢复能力
- 数据完整性保护
- 操作失败时的回滚机制
- 异常情况下的日志记录

### 3.4 安全性要求
- 操作权限验证
- 敏感操作二次确认
- 恶意输入防护
- 操作审计日志

### 3.5 兼容性要求
- 支持Windows 10/11
- 兼容不同DPI设置
- 支持不同主题（深色/浅色）

## 4. 技术需求

### 4.1 开发环境
- Python 3.8+
- PySide6
- Windows SDK (用于注册表操作)

### 4.2 技术架构
- **架构模式**: MVC (Model-View-Controller)
- **设计模式**: 观察者模式、策略模式、工厂模式
- **扩展性**: 预留插件化接口，便于后续重构

### 4.3 依赖库
```
PySide6 >= 6.0.0
PyYAML >= 6.0.0
winreg (Python标准库)
sqlite3 (Python标准库)
json (Python标准库)
configparser (Python标准库)
```

### 4.4 数据存储
- **配置存储**: QSettings
- **历史记录**: SQLite数据库
- **备份存储**: YAML格式文件（默认），也支持JSON格式
- **日志存储**: 文本文件

## 5. 用户界面需求

### 5.1 主界面布局
```
┌─────────────────────────────────────────┐
│ 菜单栏 [文件|编辑|视图|工具|帮助]         │
├─────────────────────────────────────────┤
│ 工具栏 [新建|删除|编辑|搜索|备份|设置]    │
├─────────────────────────────────────────┤
│ ┌─搜索框────┐ [系统变量|用户变量] 标签   │
│ └──────────┘                            │
├─────────────────────────────────────────┤
│ ┌─变量列表区域──────────────────────────┐│
│ │ 变量名     │ 变量值              │操作││
│ │ PATH       │ C:\Windows\System32;...│⚙️ ││
│ │ JAVA_HOME  │ C:\Program Files\Ja... │⚙️ ││
│ └──────────────────────────────────────┘│
├─────────────────────────────────────────┤
│ 详细信息面板 [选中变量的详细信息]        │
├─────────────────────────────────────────┤
│ 状态栏 [操作状态|变量数量|权限状态]      │
└─────────────────────────────────────────┘
```

### 5.2 关键对话框
- **新建/编辑变量对话框**
- **批量导入对话框**
- **备份管理对话框**
- **设置对话框**
- **PATH编辑器对话框** - 专用于PATH变量编辑的对话框

#### 5.2.1 PATH编辑器对话框界面设计
```
┌─PATH变量编辑器─────────────────────────┐
│ ┌─工具栏─────────────────────────────┐ │
│ │ [添加] [删除] [上移] [下移] [去重]  │ │
│ └──────────────────────────────────┘ │
│ ┌─路径列表─────────────────────────┬─┐ │
│ │ ☑ 1. C:\Windows\System32        │❌│ │
│ │ ☑ 2. C:\Windows               │❌│ │
│ │ ❌ 3. C:\Invalid\Path [无效]    │❌│ │
│ │ ☑ 4. D:\Tools\bin              │❌│ │
│ └──────────────────────────────────┴─┘ │
│ 路径总数: 4 | 有效: 3 | 无效: 1         │
│ ┌─添加新路径─────────────────────────┐ │
│ │ [路径输入框________________] [浏览]│ │
│ └──────────────────────────────────┘ │
│ ┌─操作按钮─────────────────────────┐ │
│ │        [确定] [取消] [预览]      │ │
│ └──────────────────────────────────┘ │
└──────────────────────────────────────┘
```

**功能说明**：
- 每行显示一个路径，带序号和有效性状态
- 支持拖拽重排序
- 双击路径可直接编辑
- 无效路径用红色标识
- 重复路径用黄色标识
- 提供路径统计信息

### 5.3 系统托盘
- 最小化到系统托盘
- 托盘菜单快速操作
- 托盘提示消息

## 6. 系统架构

### 6.1 简化模块结构
```
env_manager/
├── core/                    # 核心业务逻辑
│   ├── __init__.py
│   ├── env_controller.py    # 环境变量控制器
│   ├── backup_controller.py # 备份控制器
│   ├── registry_ops.py      # 注册表操作封装
│   ├── validator.py         # 数据验证器
│   └── exceptions.py        # 自定义异常
├── ui/                      # 用户界面
│   ├── __init__.py
│   ├── main_window.py       # 主窗口
│   ├── dialogs/             # 对话框
│   │   ├── __init__.py
│   │   ├── edit_dialog.py
│   │   ├── import_dialog.py
│   │   ├── backup_dialog.py
│   │   └── settings_dialog.py
│   └── components/          # UI组件
│       ├── __init__.py
│       ├── env_table.py
│       ├── search_widget.py
│       └── path_editor.py
├── models/                  # 数据模型
│   ├── __init__.py
│   ├── env_model.py         # 环境变量数据模型
│   └── backup_model.py      # 备份数据模型
├── utils/                   # 工具模块
│   ├── __init__.py
│   ├── config.py            # 配置管理
│   ├── logger.py            # 日志工具
│   ├── helpers.py           # 辅助函数
│   └── constants.py         # 常量定义
├── resources/               # 资源文件
│   ├── icons/
│   ├── themes/
│   └── translations/
├── tests/                   # 测试代码
├── docs/                    # 文档
├── main.py                  # 应用程序入口
├── requirements.txt         # 依赖列表
├── build.py                 # 构建脚本
└── README.md               # 项目说明
```

### 6.2 核心类设计
```python
# 主要的类接口设计
class EnvController:
    """环境变量控制器 - 核心业务逻辑"""
    def get_system_variables(self) -> Dict[str, str]
    def get_user_variables(self) -> Dict[str, str]
    def set_variable(self, name: str, value: str, system: bool)
    def delete_variable(self, name: str, system: bool)
    def validate_variable(self, name: str, value: str) -> bool

class BackupController:
    """备份控制器 - 备份恢复功能"""
    def create_backup(self, name: str = None) -> str
    def restore_backup(self, backup_id: str) -> bool
    def list_backups(self) -> List[BackupInfo]
    def cleanup_backups(self, keep_count: int = 10)

class PathController:
    """PATH变量专用控制器"""
    def parse_path(self, path_value: str) -> List[str]
    def validate_paths(self, paths: List[str]) -> List[PathInfo]
    def remove_duplicates(self, paths: List[str]) -> List[str]
    def check_path_length(self, paths: List[str]) -> bool
    def format_path_display(self, path_value: str) -> str

class MainWindow(QMainWindow):
    """主窗口 - UI控制器"""
    def __init__(self, env_controller: EnvController)
    def refresh_variables(self)
    def show_edit_dialog(self, var_name: str = None)
    def show_path_editor(self, path_value: str)
    def handle_backup_restore(self)
```

## 7. 开发计划

### 7.1 第一阶段：独立应用开发 (8周)

#### 阶段1: 基础架构 (2周)
- [ ] 项目结构搭建
- [ ] 注册表操作模块开发
- [ ] 基础UI框架搭建
- [ ] 配置和日志系统

#### 阶段2: 核心功能 (3周)
- [ ] 环境变量CRUD操作
- [ ] 主窗口界面完善
- [ ] 搜索过滤功能
- [ ] 基本的错误处理

#### 阶段3: 高级功能 (2周)
- [ ] 批量操作功能
- [ ] 备份恢复系统
- [ ] PATH专用编辑器
  - [ ] PATH值解析和格式化
  - [ ] 路径有效性验证
  - [ ] 重复路径检测和去重
  - [ ] 拖拽排序功能
  - [ ] PATH编辑器对话框UI
- [ ] 操作撤销/重做

#### 阶段4: 完善和发布 (1周)
- [ ] UI美化和主题支持
- [ ] 性能优化
- [ ] 全面测试
- [ ] 打包和发布

### 7.2 第二阶段：插件化扩展 (4周)
- [ ] 插件接口设计
- [ ] 核心逻辑重构
- [ ] 插件管理器实现
- [ ] 插件SDK和文档

### 7.3 里程碑
- **M1**: 基础功能可用 (第2周)
- **M2**: 核心功能完成 (第5周)
- **M3**: 高级功能完成 (第7周)
- **M4**: 独立应用发布 (第8周)
- **M5**: 插件化架构完成 (第12周)

## 8. 测试需求

### 8.1 单元测试
- 核心业务逻辑测试覆盖率 > 90%
- 注册表操作测试
- 数据验证测试

### 8.2 集成测试
- UI组件集成测试
- 文件操作集成测试
- 系统权限测试

### 8.3 系统测试
- 完整功能流程测试
- 性能压力测试
- 兼容性测试

### 8.4 用户验收测试
- 可用性测试
- 用户体验测试
- 实际使用场景验证

## 9. 风险分析

### 9.1 技术风险
- **Windows权限问题**: 需要处理UAC和管理员权限
- **注册表操作风险**: 错误操作可能影响系统稳定性
- **兼容性问题**: 不同Windows版本的差异

### 9.2 项目风险
- **需求变更**: 用户需求可能在开发过程中变化
- **开发进度**: 功能复杂度可能影响开发进度
- **测试覆盖**: 系统级功能测试的复杂性

### 9.3 风险应对
- 早期原型验证关键技术点
- 制定详细的测试计划
- 建立代码审查机制
- 设计回滚和恢复机制

## 10. 交付要求

### 10.1 第一阶段交付物
- 完整的源代码
- 可执行程序包（exe文件）
- 安装程序
- 用户使用手册

### 10.2 第二阶段交付物
- 插件化重构的源代码
- 插件开发SDK
- 插件开发指南
- API参考文档

### 10.3 质量标准
- 代码质量通过静态分析工具检查
- 测试覆盖率达到指定要求
- 性能指标满足需求
- 用户验收测试通过

## 11. 维护和支持

### 11.1 版本管理
- 采用语义化版本号 (Semantic Versioning)
- 定期发布更新版本
- 维护长期支持版本

### 11.2 后续开发
- 用户反馈收集和处理
- Bug修复和安全更新
- 新功能开发和集成
- 插件生态建设

---

**文档版本**: 2.0  
**创建日期**: 2024年  
**最后更新**: 2024年  
**审核状态**: 待审核  
**变更说明**: 调整为分阶段开发，优先完成独立应用
